<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Http;


class FileUploadController extends Controller
{
    public function upload(Request $request)
    {
        // dd($request->v3);
        $this->validate($request, [
            'file' => 'required|file|max:10000',
        ]);
        $file = $request->file('file');
        $fileName = $file->getClientOriginalName();
        $link =   $file->store('public/uploads');
        $link = \str_replace('public', 'storage', $link);

        $hash = hash_file("sha256", public_path($link));
        // dd($hash);
        if ($request->v3 == 'false') {
            $response = $this->getReport($hash);
            $result = collect($response);
            if ($result->get('response_code')) {
                $scans  = collect($result->get('scans'))->map(function ($scan) {
                    return collect($scan);
                });
                $result = $result->replace(['scans' => $scans]);
            }
        } else {
            // $response = collect($this->getReport($hash, true)['data']['attributes']);

            // dd(json_decode($this->getReport($hash, true)));
            dd(dd(json_decode($this->getReport($hash, true))));
            $response = $this->getReport($hash, true)['data'];
            $attributes = $response['attributes'];
            $scans  = collect($response['attributes']['last_analysis_results'])->map(function ($scan) {
                return collect($scan);
            });
            dd($response);
            //undetected

            $result = \collect([
                'scan_id' => $response['id'],
                'names' => collect($attributes['names']),
                'vhash' => $attributes['vhash'],
                'md5' => $attributes['md5'],
                'sha1' => $attributes['sha1'],
                'sha256' => $attributes['sha256'],
                'positives' => $attributes['last_analysis_stats']['malicious'],
                'total' => collect($attributes['last_analysis_stats'])->sum(),
                'scans' => $scans,
            ]);
        }




        // dd($result);
        return view('result', \compact('result', 'fileName'));
    }
    private function getReport($hash, $isV3 = false)
    {

        $ch = curl_init();
        if ($isV3)
            $this->getReportV3($ch, $hash);
        else
            $this->getReportV2($ch, $hash);

        $result = curl_exec($ch);
        $status_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        if ($status_code == 200) { // OK
            return  json_decode($result, true);
        } else {  // Error occured
            return $result;
        }

        // print("status = $status_code\n");
        // return $status_code == 200 ? json_decode($result, true) : $result;
    }
    private function getReportV3($ch, $hash)
    {

        curl_setopt($ch, CURLOPT_URL, 'https://www.virustotal.com/api/v3/files/' . $hash);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
            'x-apikey: ' . env('VT_API_KEY')
        ));
    }
    private function getReportV2($ch, $hash)
    {
        $post = array('apikey' => env('VT_API_KEY'), 'resource' => $hash);
        curl_setopt($ch, CURLOPT_URL, 'https://www.virustotal.com/vtapi/v2/file/report');
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_VERBOSE, 1); // remove this if your not debugging
        curl_setopt($ch, CURLOPT_ENCODING, 'gzip,deflate'); // please compress data
        curl_setopt($ch, CURLOPT_USERAGENT, "gzip, My php curl client");
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
    }
}